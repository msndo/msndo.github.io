# 非同期とPromise


## もの！
### Promise demo（codepen）
<a href="https://codepen.io/msndo/pen/eYMeEGg" target="_blank">https://codepen.io/msndo/pen/eYMeEGg</a>


14行目付近を片方ずつ試してみてください！

```
    // 普通に書いてやってみる（ダメ例）
    elemTrigger.addEventListener('click', execStraight);

    // 非同期チェーン（「正解例」）
    // elemTrigger.addEventListener('click', execPromised);
```

## 何をする？
非同期処理を一個ずつ順番に実行するようにバトンを渡しながら行くようにする

## なぜ要る？
非同期処理はただ並べて書いただけだと流れを無視して勝手にわーっと走り始めてしまうから。

## 非同期って言葉が
よくわからない言葉ですよね。

コンピュータは、（実は！）「機械」なので、
機械にいくつかの動作を「順番に」やらせるには「合図」が必要になります。

ようするに前の処理が「終わった」という「合図」を受けて次の処理が始まるという構図です。
自動フローを機械で組むには必ずなんらかの合図の取り決めが存在するわけです。

## デフォは「同期」
プログラム言語は普通は処理ごとに合図を出して後続処理がそれを受け止める、
つまりコマンド同士が息を合わせながらやるというのがデフォに作られています。

この仕組みが「息を『合わせる』 → 連動する → sync → 同期」とされています。
ですがいつもこんな「息を合わせてる」なんてのは気にすることはないと思います

## 同期をキャンセルしたいケース
さて、そうはいっても例えば「すごく時間がかかる処理」や「いつ終わるかわからない処理」というのもあり、
流れから一旦はぐれさせて見切り発車でやっておきたい仕事というのもあるわけです。
（どんなのがあるでしょう？？）

で、 setTimeout や ajax はその典型になるわけです。
setTimeoutはいつもだったら数秒程度の待ちで使ってるんだけど半日待たせることもできはします。
ajaxもサーバ重いといつ返ってくるかわからない、というのがあります。なのこれらは流れからはぐれさせて「非同期」でやる、という仕様です。

## 息を合わせなおす！
そして！「同期」を一度キャンセルしたんだけどその「はぐれ処理」に続く別系統の流れを作り直したい、という
場合も出るわけです（ワガママ、、）。

別系統の流れを作る方法が今はいくつかあるのですがその一つが「Promise」です。


## Promiseは何をやってるか
ブザーみたいなものです。自分が終わったかを監視してもらえるようにします（マゾ）。

なのでPromiseを使う時は何はともあれまずPromiseを書いて「監視用のブザー？を親に渡す」ということをする必要があります。
Promiseをreturnしておく、という書き方になります。

Promiseの中身に書く形で主目的の非同期処理を書きます。例ではsetTimeout()。


基本系（setTimeoutの「後」に何かやりたい）

```
// 呼び出し側。END1, END2を1秒ずつ挟んで出力

// sleep()で1秒待つ。このsleep関数はPromiseブザーを携えている
sleep(1000)

// then()はPromiseが正常ブザー(resolve())を鳴らすのを待ち受ける。
.then(function() {
  // console.logのような普通の処理はPromiseブザーがないので
  console.log('END1');

  // その場でブザーを鳴らす必要がある
  return Promise.resolve();
})
.then(function() {
  return sleep(1000); // sleep()はPromiseブザーを携えているので1行で流れを作れる
})
.then(function() {
  console.log('END2');
});

// 呼ばれる側。主目的の非同期処理（ここではsetTimeout()）とそれをラップするPromise()がある。
// まずPromiseを書いてある。監視してもらえるように親にブザーを渡している（マゾ）
function sleep() {
  return new Promise(function(resolve, reject) {
    setTimeout(function() {
      resolve();
    }, 1000);
  });
}
```

## まとめ
sleep() はまず完了通知ブザーPromiseを親に渡しておきます。
Promiseが resolve（正常終了）を検知したら
呼び出し側に定義していたthen()の中身が実行されるという構造です。
とは言ってもやってみないとわかりづらいところなので then() の中身を書き換えたりして把握してください！
